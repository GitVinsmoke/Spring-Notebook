# 面向切面编程

## AOP导言

![AOP示意图.PNG](https://github.com/GitVinsmoke/Spring-Notebook/blob/master/images/AOP%E7%A4%BA%E6%84%8F%E5%9B%BE.PNG)

如上，我们如果要做一个校园里的教务管理系统，里面涉及到课程管理和学生管理等等，那么这些业务功能需求模块在实现过程中，可能会需要安全性管理、事务管理或者其他的系统服务。这些系统的服务，跟一些业务功能模块是正交的，而这些系统的服务，也被我们称作为横切关注点。

横切关注点被描述为多处影响功能的应用，可被模块化为特殊的的类，称为<font color="red">**切面（aspect）**</font>。

面向对象(Object Oriented，简写OO)中继承和委托是重用通用功能的手段，但继承会导致产生一个脆弱对象的体系，使用委托需要对委托对象进行复杂的调用。

切面提供了取代继承和委托的另外一种选择：在一处定义通用功能，可通过声明的方式定义这个功能以何种方式在何处被调用。而无需修改受影响的类。

OOP（面向对象编程）针对业务处理过程中的实体及其属性和行为进行抽象封装，以获得更加清晰高效的逻辑单元划分。

AOP针对业务处理过程中的切面进行提取，它所面对的是业务处理过程中的某个步骤或阶段，以获得逻辑过程中各部分之间低耦合性的隔离效果。

Spring的AOP构建于IOC之上，和IOC浑然天成统一于Spring容器。

AOP代理是AOP框架所创建的对象，AOP在JavaEE应用开发中的价值在于为业务对象提供代理。

Spring有两种代理方式：

- 默认使用J2SE动态代理实现AOP代理，主要用于代理接口。

- CGLIB代理，实现类的代理，而不是接口。

Spring重点关注AOP的一个子集，叫**方法拦截（method interception）**

AOP实现策略：

- J2SE动态代理（JDK1.3引入了动态代理dynamic proxies，局限是只能针对接口，不能针对类）

- 动态字节码生成（CGLIB，Code Generator Library工具，可针对类提供代理）

- 语言扩展（AspectJ）

## 定义AOP术语

1. Aspect（切面）：横切关注点的抽象即切面。与类相似，只是两者的关注点不一样，类是对物体特征的抽象，而切面是对横切关注点的抽象。

2. Joinpoint（连接点）：所谓连接点是指那些被拦截到的点。在Spring中，这些点指的是**方法**，因为Spring值支持方法类型的连接点。实际上，joinpoint还可以是field或者类构造器。

3. Pointcut（切入点）：所谓切入点，就是指我们要对哪些joinpoint进行拦截的定义，它是连接点的一个子集。例如我们要做安全管理，要对哪些连接点进行管理，这些选出来的连接点的集合就是切入点。

4. Advice（通知）：也作增强，所谓Advice是指拦截到joinpoint之后要做的事情。通知分为，前置通知before，后置通知after，异常通知after-throwing，最终通知after-returning，环绕通知around。

5. Advisor（通知器）：Spring引入的更抽象的概念，由两部分组成：一个Advice和一个用于说明“在何处进行通知的”切入点。通知器完整模块化了一个切面。这样，切入点和通知也可以各自独立地复用。

6. Target（目标对象）：代理的目标对象（Spring中即为方法）。

7. Weave（织入）：指的是将aspect应用到target对象并导致Proxy对象创建的过程。

	在目标对象的生命周期中有多个点可以进行织入：编译期、类加载期、运行期。

8. Introduction（引入）：在不修改类代码的前提下，Introduction可以在运行期为类动态地添加一些方法或Field。

9. Interceptor（拦截器）：很多AOP框架用它来实现字段和方法的拦截，随之而来的就是在连接点处挂接一天拦截链，链条上每个拦截器通常会调用下一个拦截器。实际上，拦截是一种AOP的实现策略。

10. AOP代理（AOP Proxy）：即被通知的对象的引用。也就是说，AOP通知将在其上执行的这样一个对象引用。对于基于拦截的AOP框架来说，AOP代理的概念极为关键。AOP代理可能是J2SE的动态代理，也可能是借助字节码工具生成的。

## Spring对AOP的支持

AOP框架的基本功能；创建切入点定义切面织入的连接点。

AOP领域三足鼎立：

- AspectJ

- JBoss AOP

- Spring AOP

Spring提供四种各具特色的AOP支持：

- 经典的Spring基于代理AOP

- @AspectJ注解驱动的切面

- 纯POJO切面

- 注入式AspectJ切面

前三种都是Spring基于代理的AOP变体。

当引入了简单的声明式AOP和基于注解的AOP之后，直接使用ProxyFactoryBean的经典AOP就过时了。

Spring AOP 框架的关键点：

- Spring通知是用Java编写的，定义通知所应用的切面通常在Spring配置文件中用XML编写。

- Spring在运行期通知对象，通过使用代理类，Spring在运行期将切面织入Spring管理的Bean中。

	![SpringAOP代理.PNG](https://github.com/GitVinsmoke/Spring-Notebook/blob/master/images/SpringAOP%E4%BB%A3%E7%90%86.PNG)

- Spring的切面由包裹了目标对象的代理类实现。代理类处理方法调用，执行额外的切面逻辑，并调用目标方法。

- Spring只支持方法连接点。

如下图：切入点、通知、横切关注点等在权限系统中的技术实现

![权限系统.PNG](D:\桌面\TempPhoto\权限系统.PNG)

在进行订单管理以及产品管理时要进行权限验证，调用到一些业务逻辑方法时，可能需要进行权限验证，这些方法即为 joinpoint，切入点和通知组成切面模块（aspect）。

Spring AOP的优点：

- AOP框架与IoC容器整合。通知、通知器、切入点都是Bean，可以在同一个轻量级容器中配置。

- Spring不仅提供了AOP，还对重要企业级服务进行了模块化，比如Spring提供了现成的事务拦截管理器。

- 和Spring的其他部分一样，Spring AOP可以在不同应用服务器之间任意移植，因为不涉及自定义的类加载机制。

Spring AOP的缺点：

- 不支持字段拦截

- 只有通过Spring IoC容器获取的对象才能进行通知，不能在类装载器层面进行通知（不能让new操作符返回已经通知过的对象）。