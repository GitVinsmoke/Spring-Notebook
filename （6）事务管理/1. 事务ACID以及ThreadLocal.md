# 事务ACID以及ThreadLocal

软件开发领域，全有或全无的操作被称为事务（transaction），确保数据或资源免于处在不一致的状态。

事务是所有企业应用的核心。一个基于Web的应用系统具备了复杂的业务需求，在逻辑上可以分为三层结构：Web层、业务逻辑层、数据访问层。整个应用系统运行在同一个JVM中。这种架构中，事务管理属于业务逻辑层，通常在业务门面中划分。数据访问成参与事务过程，但不管理事务，在数据访问层的不同方法调用可以参与到一个事务过程中。

事务管理也是横切关注点（需要分离），分离后的好处：业务对象划分抽象事务，无需关注事务涉及的数据库资源；数据访问对象获取接受事务管理的数据库资源，无需关注数据库资源如何加入事务。

事务基础设施的目标在于让开发应用系统的程序员无需关注底层的事务处理，让数据访问对象仅包含实际的数据存取代码而不需要编写事务处理代码。

## 事务ACID

事务的四大特性：已经说过很多遍了，这里略过。

## ThreadLocal基础知识

Spring通过各种模板类降低了开发者使用各种数据持久化技术的难度，这些模板类是线程安全的。使用模板类访问底层数据，根据不同的持久化技术，需要绑定数据连接或会话等资源，而这些资源本身是非线程安全的，资源池只是解决缓存问题。

如对象时非线程安全的，在多线程环境下，对对象的访问应该采用synchronized进行通过，但模板类并未采用线程同步机制，因为同步会降低并发性，影响系统性能。

ThreadLocal为解决多线程并发问题提供新的解决方案，Spring事务管理的底层技术离不开它。

ThreadLocal是线程的一个本地化对象。当工作于多线程中的对象使用它来维护变量时，ThreadLocal为每个使用该变量的线程分配一个独立的变量副本。从线程的角度看，这个变量就是线程的本地变量。

#### ThreadLocal&lt;T&gt;类的方法

- void set(T value)：设置当前线程的线程局部变量的值

- T get()：返回当前线程所对应的线程局部变量

- void remove()：删除当前线程局部变量，减少内存占用

ThreadLocal&lt;T&gt;类中有一个Map，用于存储每一个线程的变量副本，Map中元素的键是线程对象，值对应线程的变量副本。

ThreadLocal为每一个线程提供了一个独立的变量副本，从而隔离了多个线程对访问数据的冲突。

ThreadLocal提供了线程安全的对象封装，可以把安全的变量封装进ThreadLocal。

<font color="red">**对于多线程资源共享的问题，同步机制采用了“以时间换空间”的方式：访问串行化，对象共享化；ThreadLocal采用了“以空间换时间”方式：访问并行化，对象独立化。**</font>

#### Spring使用ThreadLocal解决线程安全问题

一般情况下，只有无状态的Bean才可以在多线程环境下共享。

Spring中，大部分Bean声明为singleton作用域（单例）。Spring对一些Bean（RequestContextHolder、TransactionSynchronizationManager等）中非线程安全的“状态性对象”采用ThreadLocal进行封装，使其成为线程安全的，那么有状态的Bean就能以singleton的方式在多线程环境下使用了。